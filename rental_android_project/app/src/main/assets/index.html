<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿ç§Ÿç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: relative;
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #f8f9ff;
            transition: background 0.3s;
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-overdue {
            background: #f8d7da;
            color: #721c24;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .action-btn {
            padding: 6px 12px;
            margin: 0 3px;
            font-size: 14px;
            border-radius: 6px;
        }

        .btn-pay {
            background: #28a745;
        }

        .btn-edit {
            background: #ffc107;
        }

        .btn-delete {
            background: #dc3545;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
            animation: slideIn 0.5s ease;
        }

        .alert-overdue {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        .alert-today {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .days-overdue {
            font-size: 12px;
            color: #721c24;
            margin-top: 3px;
        }
    </style>

<style>
/* Responsive helpers added by assistant */
.responsive-table { overflow-x:auto; -webkit-overflow-scrolling: touch; }
.responsive-table table { width:100%; border-collapse: collapse; }
table { table-layout: auto; max-width:100%; }
img { max-width:100%; height:auto; display:block; }
@media (max-width:600px) {
  body { font-size: 14px; }
  /* make inputs/buttons full width on small screens */
  input, button, select, textarea { width:100% !important; box-sizing: border-box; }
}
</style>
</head>
<body>
    <div class="container">
        <h1>ğŸ  æˆ¿ç§Ÿç®¡ç†ç³»ç»Ÿ</h1>
        
        <div id="alerts"></div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalRooms">0</div>
                <div class="stat-label">æ€»æˆ¿é—´æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingRent">0</div>
                <div class="stat-label">å¾…æ”¶ç§Ÿé‡‘</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="overdueCount">0</div>
                <div class="stat-label">é€¾æœŸæˆ¿é—´</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthlyTotal">Â¥0</div>
                <div class="stat-label">æœ¬æœˆåº”æ”¶</div>
            </div>
        </div>

        <div class="controls">
            <button onclick="openModal()">â• æ·»åŠ æˆ¿é—´</button>
            <label for="importExcel" class="file-label">
                ğŸ“¥ å¯¼å…¥Excel
            </label>
            <input type="file" id="importExcel" accept=".xlsx,.xls" onchange="importExcel(event)">
            <button onclick="exportExcel()">ğŸ“¤ å¯¼å‡ºExcel</button>
            <button onclick="checkDueRents()">ğŸ”” æ£€æŸ¥åˆ°æœŸç§Ÿé‡‘</button>
            <button onclick="clearAllData()" style="background: #dc3545;">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
        </div>

        <div class="responsive-table">
<table id="rentTable">
            <thead>
                <tr>
                    <th>æˆ¿é—´å·</th>
                    <th>ç§Ÿå®¢å§“å</th>
                    <th>æœˆç§Ÿé‡‘</th>
                    <th>æ”¶ç§Ÿæ—¥æœŸ</th>
                    <th>ä¸Šæ¬¡æ”¶ç§Ÿ</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="rentTableBody"></tbody>
        </table>
</div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 style="margin-bottom: 20px; color: #333;">æ·»åŠ /ç¼–è¾‘æˆ¿é—´</h2>
            <form id="roomForm">
                <div class="form-group">
                    <label>æˆ¿é—´å·</label>
                    <input type="text" id="roomNumber" required placeholder="ä¾‹å¦‚: 101">
                    <div class="error" id="roomNumberError">æˆ¿é—´å·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–æˆ¿é—´å·</div>
                </div>
                <div class="form-group">
                    <label>ç§Ÿå®¢å§“å</label>
                    <input type="text" id="tenantName" required placeholder="è¯·è¾“å…¥ç§Ÿå®¢å§“å">
                </div>
                <div class="form-group">
                    <label>æœˆç§Ÿé‡‘ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="monthlyRent" min="0" required placeholder="è¯·è¾“å…¥æœˆç§Ÿé‡‘">
                </div>
                <div class="form-group">
                    <label>æ”¶ç§Ÿæ—¥æœŸï¼ˆæ¯æœˆå‡ å·ï¼‰</label>
                    <input type="number" id="rentDay" min="1" max="31" required placeholder="1-31">
                </div>
                <div class="form-group">
                    <label>ä¸Šæ¬¡æ”¶ç§Ÿæ—¥æœŸ</label>
                    <input type="date" id="lastPayment">
                    <div class="error" id="lastPaymentError">æ—¥æœŸä¸èƒ½æ˜¯æœªæ¥æ—¥æœŸ</div>
                </div>
                <button type="submit" style="width: 100%; margin-top: 10px;">ä¿å­˜</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let rooms = [];
        let editingIndex = -1;
        let originalRoomNumber = '';

        // åˆå§‹åŒ–
        function init() {
            const savedData = localStorage.getItem('rentRooms');
            if (savedData) {
                try {
                    rooms = JSON.parse(savedData);
                } catch (e) {
                    console.error('è§£æå­˜å‚¨æ•°æ®å¤±è´¥:', e);
                    rooms = [];
                }
            }
            renderTable();
            updateStats();
            checkDueRents();
        }

        // ä¿å­˜æ•°æ®
        function saveData() {
            localStorage.setItem('rentRooms', JSON.stringify(rooms));
        }

        // æ‰“å¼€æ¨¡æ€æ¡†
        function openModal() {
            document.getElementById('addModal').style.display = 'block';
            document.getElementById('roomForm').reset();
            document.getElementById('roomNumberError').style.display = 'none';
            document.getElementById('lastPaymentError').style.display = 'none';
            editingIndex = -1;
            originalRoomNumber = '';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        // éªŒè¯è¡¨å•
        function validateForm() {
            const roomNumber = document.getElementById('roomNumber').value.trim();
            const lastPayment = document.getElementById('lastPayment').value;
            const today = new Date().toISOString().split('T')[0];
            
            // æ£€æŸ¥æˆ¿é—´å·æ˜¯å¦å·²å­˜åœ¨ï¼ˆç¼–è¾‘æ¨¡å¼é™¤å¤–ï¼‰
            if (editingIndex === -1 || roomNumber !== originalRoomNumber) {
                const isDuplicate = rooms.some(room => room.roomNumber === roomNumber);
                if (isDuplicate) {
                    document.getElementById('roomNumberError').style.display = 'block';
                    return false;
                }
            }
            
            // æ£€æŸ¥ä¸Šæ¬¡æ”¶ç§Ÿæ—¥æœŸæ˜¯å¦æ˜¯æœªæ¥æ—¥æœŸ
            if (lastPayment && lastPayment > today) {
                document.getElementById('lastPaymentError').style.display = 'block';
                return false;
            }
            
            return true;
        }

        // æ·»åŠ /ç¼–è¾‘æˆ¿é—´
        document.getElementById('roomForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!validateForm()) return;
            
            const room = {
                roomNumber: document.getElementById('roomNumber').value.trim(),
                tenantName: document.getElementById('tenantName').value.trim(),
                monthlyRent: parseFloat(document.getElementById('monthlyRent').value),
                rentDay: parseInt(document.getElementById('rentDay').value),
                lastPayment: document.getElementById('lastPayment').value || null
            };

            if (editingIndex >= 0) {
                rooms[editingIndex] = room;
            } else {
                rooms.push(room);
            }

            saveData();
            renderTable();
            updateStats();
            closeModal();
            showAlert(editingIndex >= 0 ? 'æˆ¿é—´ä¿¡æ¯æ›´æ–°æˆåŠŸï¼' : 'æˆ¿é—´æ·»åŠ æˆåŠŸï¼', 'success');
        });

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type === 'success' ? 'alert-today' : type === 'error' ? 'alert-overdue' : ''}`;
            alertDiv.innerHTML = `ğŸ“¢ ${message}`;
            
            const alertsContainer = document.getElementById('alerts');
            alertsContainer.appendChild(alertDiv);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤æç¤º
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('rentTableBody');
            tbody.innerHTML = '';

            if (rooms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">æš‚æ— æˆ¿é—´æ•°æ®</td></tr>';
                return;
            }

            rooms.forEach((room, index) => {
                const tr = document.createElement('tr');
                const statusInfo = getPaymentStatus(room);
                
                tr.innerHTML = `
                    <td>${room.roomNumber}</td>
                    <td>${room.tenantName}</td>
                    <td>Â¥${room.monthlyRent.toFixed(2)}</td>
                    <td>æ¯æœˆ${room.rentDay}å·</td>
                    <td>${room.lastPayment || 'æ— è®°å½•'}</td>
                    <td>
                        <span class="status status-${statusInfo.status}">${statusInfo.text}</span>
                        ${statusInfo.daysOverdue > 0 ? `<div class="days-overdue">é€¾æœŸ ${statusInfo.daysOverdue} å¤©</div>` : ''}
                    </td>
                    <td>
                        <button class="action-btn btn-pay" onclick="markPaid(${index})" ${statusInfo.status === 'paid' ? 'disabled style="opacity:0.5;"' : ''}>æ”¶ç§Ÿ</button>
                        <button class="action-btn btn-edit" onclick="editRoom(${index})">ç¼–è¾‘</button>
                        <button class="action-btn btn-delete" onclick="deleteRoom(${index})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // è·å–æ”¯ä»˜çŠ¶æ€ï¼ˆä¿®å¤åçš„é€»è¾‘ï¼‰
        function getPaymentStatus(room) {
            if (!room.lastPayment) {
                // ä»æœªæ”¯ä»˜è¿‡
                const today = new Date();
                const rentDay = room.rentDay;
                const currentDay = today.getDate();
                
                if (currentDay > rentDay) {
                    const daysOverdue = currentDay - rentDay;
                    return { status: 'overdue', text: 'å·²é€¾æœŸ', daysOverdue };
                } else {
                    return { status: 'pending', text: 'å¾…æ”¯ä»˜', daysOverdue: 0 };
                }
            }
            
            const today = new Date();
            const lastPayment = new Date(room.lastPayment);
            const rentDay = room.rentDay;
            
            // è®¡ç®—ä¸Šæ¬¡æ”¯ä»˜æœˆä»½å’Œå½“å‰æœˆä»½ä¹‹é—´çš„å·®å¼‚
            const monthsDiff = (today.getFullYear() - lastPayment.getFullYear()) * 12 + 
                              (today.getMonth() - lastPayment.getMonth());
            
            if (monthsDiff === 0) {
                // æœ¬æœˆå·²æ”¯ä»˜
                return { status: 'paid', text: 'å·²æ”¯ä»˜', daysOverdue: 0 };
            } else if (monthsDiff > 0) {
                // ä¸Šæ¬¡æ”¯ä»˜æ˜¯ä¹‹å‰æœˆä»½
                const currentDay = today.getDate();
                
                if (currentDay > rentDay) {
                    const daysOverdue = currentDay - rentDay;
                    return { status: 'overdue', text: 'å·²é€¾æœŸ', daysOverdue };
                } else {
                    return { status: 'pending', text: 'å¾…æ”¯ä»˜', daysOverdue: 0 };
                }
            }
            
            // å¼‚å¸¸æƒ…å†µï¼šä¸Šæ¬¡æ”¯ä»˜æ—¥æœŸæ˜¯æœªæ¥æ—¥æœŸ
            return { status: 'pending', text: 'å¾…æ”¯ä»˜', daysOverdue: 0 };
        }

        // æ ‡è®°å·²æ”¯ä»˜
        function markPaid(index) {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            const dateString = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            
            rooms[index].lastPayment = dateString;
            saveData();
            renderTable();
            updateStats();
            showAlert(`æˆ¿é—´ ${rooms[index].roomNumber} ç§Ÿé‡‘å·²æ ‡è®°ä¸ºå·²æ”¯ä»˜ï¼`, 'success');
        }

        // ç¼–è¾‘æˆ¿é—´
        function editRoom(index) {
            const room = rooms[index];
            document.getElementById('roomNumber').value = room.roomNumber;
            document.getElementById('tenantName').value = room.tenantName;
            document.getElementById('monthlyRent').value = room.monthlyRent;
            document.getElementById('rentDay').value = room.rentDay;
            document.getElementById('lastPayment').value = room.lastPayment || '';
            
            editingIndex = index;
            originalRoomNumber = room.roomNumber;
            
            document.getElementById('addModal').style.display = 'block';
            document.getElementById('roomNumberError').style.display = 'none';
            document.getElementById('lastPaymentError').style.display = 'none';
        }

        // åˆ é™¤æˆ¿é—´
        function deleteRoom(index) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æˆ¿é—´ ${rooms[index].roomNumber} çš„ä¿¡æ¯å—ï¼Ÿ`)) {
                const roomNumber = rooms[index].roomNumber;
                rooms.splice(index, 1);
                saveData();
                renderTable();
                updateStats();
                showAlert(`æˆ¿é—´ ${roomNumber} å·²åˆ é™¤ï¼`, 'success');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                rooms = [];
                saveData();
                renderTable();
                updateStats();
                showAlert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼', 'success');
            }
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('totalRooms').textContent = rooms.length;
            
            let pendingCount = 0;
            let overdueCount = 0;
            let monthlyTotal = 0;
            
            rooms.forEach(room => {
                const statusInfo = getPaymentStatus(room);
                if (statusInfo.status === 'pending') pendingCount++;
                if (statusInfo.status === 'overdue') overdueCount++;
                if (statusInfo.status !== 'paid') monthlyTotal += room.monthlyRent;
            });
            
            document.getElementById('pendingRent').textContent = pendingCount;
            document.getElementById('overdueCount').textContent = overdueCount;
            document.getElementById('monthlyTotal').textContent = `Â¥${monthlyTotal.toFixed(2)}`;
        }

        // æ£€æŸ¥åˆ°æœŸç§Ÿé‡‘
        function checkDueRents() {
            const alerts = document.getElementById('alerts');
            alerts.innerHTML = '';
            
            const today = new Date();
            const currentDay = today.getDate();
            let overdueRooms = [];
            let dueToday = [];
            
            rooms.forEach(room => {
                const statusInfo = getPaymentStatus(room);
                if (statusInfo.status === 'overdue') {
                    overdueRooms.push(room);
                } else if (room.rentDay === currentDay && statusInfo.status !== 'paid') {
                    dueToday.push(room);
                }
            });
            
            if (overdueRooms.length > 0) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-overdue';
                alert.innerHTML = `âš ï¸ <strong>é€¾æœŸæé†’ï¼š</strong>æˆ¿é—´ ${overdueRooms.map(r => r.roomNumber).join('ã€')} ç§Ÿé‡‘å·²é€¾æœŸï¼Œè¯·å°½å¿«æ”¶å–ï¼`;
                alerts.appendChild(alert);
            }
            
            if (dueToday.length > 0) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-today';
                alert.innerHTML = `ğŸ“… <strong>ä»Šæ—¥æ”¶ç§Ÿï¼š</strong>æˆ¿é—´ ${dueToday.map(r => r.roomNumber).join('ã€')} ä»Šæ—¥éœ€è¦æ”¶ç§Ÿï¼`;
                alerts.appendChild(alert);
            }
            
            if (overdueRooms.length === 0 && dueToday.length === 0) {
                showAlert('ç›®å‰æ²¡æœ‰é€¾æœŸæˆ–ä»Šæ—¥åˆ°æœŸçš„ç§Ÿé‡‘ï¼', 'success');
            }
        }

        // å¯¼å…¥Excel
        function importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        showAlert('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®ï¼', 'error');
                        return;
                    }
                    
                    const importedRooms = jsonData.map(row => ({
                        roomNumber: String(row['æˆ¿é—´å·'] || row.roomNumber || ''),
                        tenantName: String(row['ç§Ÿå®¢å§“å'] || row.tenantName || ''),
                        monthlyRent: parseFloat(row['æœˆç§Ÿé‡‘'] || row.monthlyRent || 0),
                        rentDay: parseInt(row['æ”¶ç§Ÿæ—¥æœŸ'] || row.rentDay || 1),
                        lastPayment: row['ä¸Šæ¬¡æ”¶ç§Ÿ'] || row.lastPayment || null
                    }));
                    
                    // æ£€æŸ¥é‡å¤æˆ¿é—´å·
                    const duplicateRooms = importedRooms.filter(newRoom => 
                        rooms.some(existingRoom => existingRoom.roomNumber === newRoom.roomNumber)
                    );
                    
                    if (duplicateRooms.length > 0) {
                        if (!confirm(`å¯¼å…¥çš„æ•°æ®ä¸­åŒ…å« ${duplicateRooms.length} ä¸ªé‡å¤æˆ¿é—´å·ï¼Œæ˜¯å¦è¦†ç›–ç°æœ‰æ•°æ®ï¼Ÿ`)) {
                            return;
                        }
                        
                        // ç§»é™¤é‡å¤çš„æˆ¿é—´
                        rooms = rooms.filter(existingRoom => 
                            !importedRooms.some(newRoom => newRoom.roomNumber === existingRoom.roomNumber)
                        );
                    }
                    
                    // æ·»åŠ æ–°æˆ¿é—´
                    rooms = [...rooms, ...importedRooms];
                    saveData();
                    renderTable();
                    updateStats();
                    showAlert(`æˆåŠŸå¯¼å…¥ ${importedRooms.length} æ¡æˆ¿é—´æ•°æ®ï¼`, 'success');
                    
                    // é‡ç½®æ–‡ä»¶è¾“å…¥
                    event.target.value = '';
                } catch (error) {
                    console.error('å¯¼å…¥Excelå¤±è´¥:', error);
                    showAlert('å¯¼å…¥Excelå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼', 'error');
                }
            };
            reader.readAsBinaryString(file);
        }

        // å¯¼å‡ºExcel
        function exportExcel() {
            if (rooms.length === 0) {
                showAlert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼', 'error');
                return;
            }
            
            const exportData = rooms.map(room => {
                const statusInfo = getPaymentStatus(room);
                return {
                    'æˆ¿é—´å·': room.roomNumber,
                    'ç§Ÿå®¢å§“å': room.tenantName,
                    'æœˆç§Ÿé‡‘': room.monthlyRent,
                    'æ”¶ç§Ÿæ—¥æœŸ': room.rentDay,
                    'ä¸Šæ¬¡æ”¶ç§Ÿ': room.lastPayment || '',
                    'çŠ¶æ€': statusInfo.text,
                    'é€¾æœŸå¤©æ•°': statusInfo.daysOverdue > 0 ? statusInfo.daysOverdue : ''
                };
            });
            
            try {
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'æˆ¿ç§Ÿç®¡ç†');
                XLSX.writeFile(wb, `æˆ¿ç§Ÿç®¡ç†_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
                showAlert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
                showAlert('å¯¼å‡ºExcelå¤±è´¥ï¼', 'error');
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('addModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        init();
        
        // æ¯å¤©è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
        setInterval(checkDueRents, 24 * 60 * 60 * 1000);
    </script>
</body>
</html>